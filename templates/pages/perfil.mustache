{{< layout}}
{{$main}}

<main class="profile-page">

  <section class="profile-card">
    <img id="avatar" src="https://i.pravatar.cc/80?img=32" class="avatar">

    <div class="profile-info">
      <h2 id="nome">A carregar...</h2>
      <p id="descricao"></p>

      <div class="meta">
        <span id="avaliacoes"></span>
        <span id="localizacao"></span>
      </div>
    </div>

    <button id="edit-btn" class="edit-btn">Editar Perfil</button>
  </section>

  <section class="tabs">
    <button class="tab-btn active" data-tab="portfolio">Portf√≥lio</button>
    <button class="tab-btn" data-tab="servicos">Servi√ßos</button>
    <button class="tab-btn" data-tab="avaliacoes">Avalia√ß√µes</button>
  </section>

  <section class="tab-content">
    <div id="portfolio" class="tab-panel active">
      <div id="portfolio-items"></div>
    </div>

    <div id="servicos" class="tab-panel">
      <ul id="services-list"></ul>
    </div>

    <div id="avaliacoes" class="tab-panel">
      <div id="reviews-list"></div>
    </div>
  </section>

</main>

<script>
/* =========================
   VERIFICA√á√ÉO DE SESS√ÉO
========================= */
const urlParams = new URLSearchParams(window.location.search);
let userId = urlParams.get('id') || localStorage.getItem('userId') || sessionStorage.getItem('userId');

// Se n√£o h√° id na URL, mas existe no localStorage/sessionStorage, redireciona para perfil.html?id=ID
if (!urlParams.get('id') && userId) {
  window.location.href = 'perfil.html?id=' + encodeURIComponent(userId);
}

// Se n√£o h√° id em nenhum lugar, mostra erro ou redireciona para login
if (!userId) {
  document.getElementById('nome').textContent = 'Erro: sess√£o n√£o encontrada.';
  // window.location.href = 'login.html'; // Descomente se quiser redirecionar
} else {
  // Salva id no localStorage para persist√™ncia
  localStorage.setItem('userId', userId);
  console.log('ID usado:', userId);
  fetch('api/get_user_type.php?id=' + encodeURIComponent(userId))
    .then(r => r.json())
    .then(resp => {
      console.log('Resposta get_user_type:', resp);
      if (resp.erro) {
        document.getElementById('nome').textContent = 'Erro: ' + resp.erro;
        return;
      }
      // üëâ CLIENTE: redireciona para perfilcliente
      if (resp.tipo === 'cliente') {
        window.location.href = 'perfilcliente.html?id=' + userId;
        return;
      }
      // üëâ FOT√ìGRAFO CONTINUA
      carregarPerfil(userId);
    })
    .catch((err) => {
      document.getElementById('nome').textContent = 'Erro de sess√£o.';
    });
}


/* =========================
   CARREGAR PERFIL
========================= */
function carregarPerfil(userId) {
  const params = new URLSearchParams(window.location.search);
  const perfilId = params.get('id') || userId;

  fetch('api/fotografo_perfil.php?id=' + encodeURIComponent(perfilId))
    .then(r => r.json())
    .then(f => {

      if (f.erro) {
        document.getElementById('nome').textContent = f.erro;
        return;
      }

      document.getElementById('nome').textContent = f.nome;
      document.getElementById('descricao').textContent = f.descricao || '';
      document.getElementById('avaliacoes').textContent =
        f.avaliacao ? `‚≠ê ${f.avaliacao}` : '';
      document.getElementById('localizacao').textContent =
        f.distrito && f.concelho ? `${f.distrito}, ${f.concelho}` : '';

      if (f.imagemperfil) {
        document.getElementById('avatar').src = f.imagemperfil;
      }

      // bot√£o editar
      const editBtn = document.getElementById('edit-btn');
      if (perfilId != userId) {
        editBtn.style.display = 'none';
      } else {
        editBtn.onclick = () => {
          window.location.href = 'edit-fotografo.html';
        };
      }

      // servi√ßos
      const services = document.getElementById('services-list');
      services.innerHTML = '';
      if (f.Categoria) {
        services.innerHTML = `<li> <strong>${f.Categoria}</strong></li>`;
      }
      if (f.servicos) {
        f.servicos.split(',').forEach(s => {
          services.innerHTML += `<li>${s.trim()}</li>`;
        });
      } else if (!f.Categoria) {
        services.innerHTML = '<li>Sem servi√ßos.</li>';
      }

      // portf√≥lio
      const portfolio = document.getElementById('portfolio-items');
      portfolio.innerHTML = '';
      if (Array.isArray(f.portfolio)) {
        f.portfolio.forEach(img => {
          portfolio.innerHTML += `<img src="${img}" style="max-width:180px;margin:8px;border-radius:12px;">`;
        });
      } else {
        portfolio.innerHTML = '<span style="color:#888">Sem portf√≥lio.</span>';
      }
    });
}

/* =========================
   TABS
========================= */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});
</script>

{{/main}}
{{/layout}}
