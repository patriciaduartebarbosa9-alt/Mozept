{{< layout}}
{{$main}}
<script>
    // Estado de edição do portfólio
    let portfolioEditMode = false;
    let editBtn, addBtn, portfolioItems;
    window.addEventListener('DOMContentLoaded', function() {
      editBtn = document.getElementById('edit-portfolio-btn');
      addBtn = document.getElementById('add-portfolio-item');
      portfolioItems = document.getElementById('portfolio-items');
      if (editBtn) {
        editBtn.addEventListener('click', function() {
          portfolioEditMode = !portfolioEditMode;
          // Habilita/Desabilita campos
          document.querySelectorAll('.portfolio-item-edit input, .portfolio-item-edit textarea').forEach(el => {
            el.disabled = !portfolioEditMode;
            el.style.background = portfolioEditMode ? '#fff' : '#f2f2f2';
          });
          // Mostra/oculta botão remover
          document.querySelectorAll('.remove-portfolio-item').forEach(btn => {
            btn.style.display = portfolioEditMode ? 'inline-block' : 'none';
          });
          // Mostra/oculta botão adicionar
          addBtn.style.display = portfolioEditMode ? 'inline-block' : 'none';
        });
      }
    });
</script>
<main class="edit-page">
  <h1>Editar Perfil</h1>
  <form class="edit-form" id="edit-profile-form">
    <!-- FOTO DE PERFIL -->
    <section class="edit-section">
      <h2>Foto de Perfil</h2>
      <div id="profile-preview" style="margin-bottom:12px;"></div>
      <input type="file" accept="image/*" id="profile-pic" style="display:none;">
      <label for="profile-pic" class="upload-label" style="display:inline-block; background:#eee; color:#7b0000; border-radius:8px; padding:10px 24px; cursor:pointer; font-weight:500;">Escolher imagem</label>
    </section>
    <!-- PORTFOLIO -->
    <section class="edit-section">
      <h2>Editar Portfólio</h2>
      <div id="portfolio-items"></div>
      <div id="portfolio-edit-controls" style="display:flex; gap:12px; margin:12px 0;">
        <button type="button" id="edit-portfolio-btn" style="background:#7b0000; color:#fff; border:none; padding:12px 32px; border-radius:8px; font-size:16px; cursor:pointer;">Editar Portfólio</button>
        <button type="button" id="add-portfolio-item" style="background:#eee; color:#7b0000; border:none; padding:12px 32px; border-radius:8px; font-size:16px; cursor:pointer; display:none;">Adicionar</button>
      </div>
    </section>
    <!-- SERVIÇOS -->
<section class="edit-section">
    <h2>Editar Serviços</h2>

    <select id="categoria-select" style="width:100%;background:#f2f2f2;border:none;border-radius:8px;padding:14px 16px;font-size:1rem;">
    <option value="">Categoria</option>
    <option value="casamento">Casamento</option>
    <option value="evento">Evento</option>
    <option value="retrato">Retrato</option>
    <option value="produto">Produto</option>
    </select>
</section>

    <!-- PALAVRA PASSE -->
    <section class="edit-section">
      <h2>Alterar Palavra Passe</h2>
      <input type="password" placeholder="Palavra passe atual">
      <input type="password" placeholder="Nova palavra passe">
      <input type="password" placeholder="Confirmar nova palavra passe">
    </section>
    <button type="submit" id="save-profile-btn" style="background:#7b0000; color:#fff; border:none; padding:14px 40px; border-radius:8px; font-size:18px; font-weight:600; margin:24px auto 0; display:block;">Salvar</button>
  </form>
  <a href="perfil.html" class="back-link">Voltar ao Perfil</a>
<script>
// Adicionar item ao portfólio
window.addEventListener('DOMContentLoaded', function() {
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      const idx = document.querySelectorAll('.portfolio-item-edit').length;
      const item = document.createElement('div');
      item.className = 'portfolio-item-edit';
      item.style = 'margin-bottom:18px; border:1px solid #eee; border-radius:10px; padding:16px; background:#fafafa;';
      item.innerHTML = `
        <label style='display:block; margin-bottom:8px;'>Imagem*
          <input type='file' accept='image/*' class='portfolio-img-input' data-idx='${idx}' style='display:block; margin-top:4px;' ${portfolioEditMode ? '' : 'disabled'}>
          <div class='portfolio-img-preview' style='margin-top:8px;'></div>
        </label>
        <label style='display:block; margin-bottom:8px;'>Nome*
          <input type='text' class='portfolio-name' placeholder='Nome do projeto' required style='width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;' ${portfolioEditMode ? '' : 'disabled'}>
        </label>
        <label style='display:block; margin-bottom:8px;'>Descrição*
          <textarea class='portfolio-desc' placeholder='Descreva o projeto...' required style='width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;' ${portfolioEditMode ? '' : 'disabled'}></textarea>
        </label>
        <button type='button' class='remove-portfolio-item' style='background:#eee; color:#7b0000; border:none; border-radius:6px; padding:6px 18px; cursor:pointer; margin-top:6px; display:${portfolioEditMode ? 'inline-block' : 'none'};'>Remover</button>
      `;
      if (portfolioItems) portfolioItems.appendChild(item);
      // Preview da imagem
      const imgInput = item.querySelector('.portfolio-img-input');
      if (imgInput) {
        imgInput.addEventListener('change', function() {
          const preview = item.querySelector('.portfolio-img-preview');
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              preview.innerHTML = `<img src='${e.target.result}' alt='Preview' style='max-width:100px; max-height:100px; border-radius:8px; box-shadow:0 2px 8px #0001;'>`;
            };
            reader.readAsDataURL(this.files[0]);
          } else {
            preview.innerHTML = '';
          }
        });
      }
      // Remover item
      const removeBtn = item.querySelector('.remove-portfolio-item');
      if (removeBtn) {
        removeBtn.addEventListener('click', function() {
          item.remove();
        });
      }
    });
  }
});
// Inicialmente, campos não editáveis/remover oculto
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.portfolio-item-edit input, .portfolio-item-edit textarea').forEach(el => {
    el.disabled = true;
    el.style.background = '#f2f2f2';
  });
  document.querySelectorAll('.remove-portfolio-item').forEach(btn => {
    btn.style.display = 'none';
  });
  addBtn.style.display = 'none';
});
// Preview da imagem de perfil
const inputPic = document.getElementById('profile-pic');
const preview = document.getElementById('profile-preview');
if (inputPic) {
  inputPic.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width:120px; max-height:120px; border-radius:50%; box-shadow:0 2px 8px #0001;">`;
      };
      reader.readAsDataURL(this.files[0]);
    } else {
      preview.innerHTML = '';
    }
  });
}

// Carregar dados do perfil logado
function getUserId() {
  // Verifica se há sessão ou token
  let userId = localStorage.getItem('userId');
  if (!userId) {
    // Tenta buscar de cookie/sessionStorage ou redireciona para login
    userId = sessionStorage.getItem('userId');
  }
  if (!userId) {
    alert('Sessão expirada. Faça login novamente.');
    window.location.href = 'login.html';
    return '';
  }
  return userId;
}

window.addEventListener('DOMContentLoaded', function() {
  fetch('api/fotografo_perfil.php?id=' + encodeURIComponent(getUserId()))
    .then(async r => {
      const text = await r.text();
      try {
        const f = JSON.parse(text);
        if (f.nome) {
          document.getElementById('profile-preview').innerHTML = f.imagemperfil ? `<img src="${f.imagemperfil}" style="max-width:120px;max-height:120px;border-radius:50%;">` : '';
          document.getElementById('categoria-select').value = f.Categoria || '';
          // Preencher outros campos conforme necessário
        }
      } catch (e) {
        document.getElementById('profile-preview').innerHTML = '<span style="color:#888">Erro ao carregar perfil.</span>';
      }
    });
});

// Salvar alterações do perfil
window.addEventListener('DOMContentLoaded', function() {
  const editForm = document.getElementById('edit-profile-form');
  if (editForm) {
    editForm.addEventListener('submit', function(e) {
      e.preventDefault();
      try {
        const categoria = document.getElementById('categoria-select').value;
        const inputPic = document.getElementById('profile-pic');
        const formData = new FormData();
        formData.append('id', getUserId());
        formData.append('categoria', categoria);
        if (inputPic && inputPic.files && inputPic.files[0]) {
          formData.append('imagemperfil', inputPic.files[0]);
        }
        // Coletar imagens e dados do portfólio
        const portfolioImgs = document.querySelectorAll('.portfolio-img-input');
        const portfolioNames = document.querySelectorAll('.portfolio-name');
        const portfolioDescs = document.querySelectorAll('.portfolio-desc');
        for (let i = 0; i < portfolioImgs.length; i++) {
          if (portfolioImgs[i].files && portfolioImgs[i].files[0]) {
            formData.append('portfolio_img_' + i, portfolioImgs[i].files[0]);
          }
          formData.append('portfolio_name_' + i, portfolioNames[i] ? portfolioNames[i].value : '');
          formData.append('portfolio_desc_' + i, portfolioDescs[i] ? portfolioDescs[i].value : '');
        }
        formData.append('portfolio_count', portfolioImgs.length);
        fetch('api/update_fotografo.php', {
          method: 'POST',
          body: formData
        })
        .then(async r => {
          let text = await r.text();
          let resp;
          try {
            resp = JSON.parse(text);
          } catch (err) {
            alert('Erro ao processar resposta do servidor.');
            console.error('Resposta inválida:', text);
            return;
          }
          if (resp.sucesso) {
            if (resp.imagemperfil) {
              document.getElementById('profile-preview').innerHTML = `<img src='${resp.imagemperfil}' style='max-width:120px;max-height:120px;border-radius:50%;'>`;
            }
            alert('Perfil atualizado com sucesso!');
            window.location.href = 'perfil.html?id=' + getUserId();
          } else {
            alert('Erro ao atualizar perfil: ' + (resp.erro || ''));
            console.error('Erro ao atualizar perfil:', resp);
          }
        })
        .catch(err => {
          alert('Erro de rede ao salvar perfil.');
          console.error('Erro de rede:', err);
        });
      } catch (err) {
        alert('Erro inesperado ao tentar salvar.');
        console.error('Erro inesperado:', err);
      }
    });
  } else {
    console.error('Formulário de edição de perfil não encontrado!');
  }
});
</script>
</main>
{{/main}}
{{/layout}}
