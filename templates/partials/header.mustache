<link rel="stylesheet" href="/assets/css/styles.css">
<header class="header">
    <div class="logo">{{site.title}}</div>

    <nav class="nav">
        <a href="{{navPrefix}}index.html"{{#isHome}} class="active"{{/isHome}}>Inicial</a>
        <a href="{{navPrefix}}reserva.html"{{#isReserva}} class="active"{{/isReserva}}>Reservar</a>
        <a href="{{navPrefix}}mensagens.html"{{#isMensagens}} class="active"{{/isMensagens}}>Mensagens</a>
        <a href="{{navPrefix}}blog.html"{{#isBlog}} class="active"{{/isBlog}}>Blog</a>
        <a href="{{navPrefix}}about.html"{{#isAbout}} class="active"{{/isAbout}}>Sobre Nós</a>
    </nav>

    <div class="profile-menu-container" style="position: relative;">
        <button class="profile-btn" id="profile-btn" aria-label="Menu de Perfil" onclick="document.getElementById('profile-dropdown').classList.toggle('show')">
            <img id="header-avatar" src="{{#user.imagemperfil}}{{user.imagemperfil}}{{/user.imagemperfil}}{{^user.imagemperfil}}https://i.pravatar.cc/64?img=12{{/user.imagemperfil}}" alt="Perfil" class="profile-avatar">
          <script>
          // Mostrar/ocultar 'Ver Perfil' dinamicamente
          document.addEventListener('DOMContentLoaded', function() {
            var perfilLink = document.getElementById('ver-perfil-link');
            var userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            if (perfilLink) {
              if (!userId) {
                perfilLink.style.display = 'none';
              } else {
                perfilLink.style.display = 'block';
              }
            }
          });
          // Propagar o id nos links de navegação para páginas privadas
          document.addEventListener('DOMContentLoaded', function() {
            var userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
            if (userId) {
              document.querySelectorAll('nav.nav a').forEach(function(link) {
                var url = new URL(link.href, window.location.origin);
                // Só propaga id se for página privada
                if (url.pathname.includes('perfil.html') || url.pathname.includes('mensagens.html') || url.pathname.includes('reserva.html')) {
                  url.searchParams.set('id', userId);
                  link.href = url.pathname + url.search;
                } else {
                  // Para páginas públicas, remove id
                  url.searchParams.delete('id');
                  link.href = url.pathname + url.search;
                }
              });
            }
          });
          // Buscar imagem de perfil da BD em tempo real para o header
          document.addEventListener('DOMContentLoaded', function() {
            var img = document.getElementById('header-avatar');
            function getUserId() {
              return localStorage.getItem('userId') || sessionStorage.getItem('userId');
            }
            var userId = getUserId();
            if (img && userId) {
              // Buscar tipo de usuário
              fetch('api/get_user_type.php?id=' + encodeURIComponent(userId))
                .then(r => r.json())
                .then(resp => {
                  if (resp.tipo === 'cliente') {
                    fetch('api/get_cliente_by_id.php?id=' + encodeURIComponent(userId))
                      .then(r => r.json())
                      .then(cliente => {
                        console.log('Resultado fetch cliente:', cliente);
                        if (cliente && cliente.imagem) {
                          img.src = 'assets/images/' + cliente.imagem;
                        } else {
                          img.src = 'assets/images/default.png';
                        }
                      });
                  } else {
                    fetch('api/fotografo_perfil.php?id=' + encodeURIComponent(userId))
                      .then(async r => {
                        const text = await r.text();
                        try {
                          const f = JSON.parse(text);
                          if (f.imagemperfil) {
                            img.src = f.imagemperfil;
                          } else {
                            img.src = 'assets/images/default.png';
                          }
                        } catch (e) {
                          img.src = 'assets/images/default.png';
                        }
                      });
                  }
                });
            }
          });
          </script>
          {{#user.authenticated}}
          <span style="margin-left:8px; font-weight:500; color:#7b0000;">ID: {{user.id}}</span>
          {{/user.authenticated}}
        </button>
        <div class="profile-dropdown" id="profile-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: #fff; border: 1px solid #dbdbdb; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); min-width: 180px; z-index: 1000;">
                  
                  <button id="btn-logout" style="display: block; width: 100%; padding: 10px 16px; background: none; border: none; text-align: left; color: #ab2a2a; cursor: pointer;">Terminar Sessão</button>
                  {{^user.authenticated}}
                    <a href="#" id="ver-perfil-link" style="display: block; padding: 10px 16px; color: #262626; text-decoration: none;">Ver Perfil</a>
                    <hr style="margin: 0;">
                  {{/user.authenticated}}
                  {{#user.authenticated}}
                    <a href="{{navPrefix}}registo.html" style="display: block; padding: 10px 16px; color: #262626; text-decoration: none;">Registar</a>
                  {{/user.authenticated}}
        </div>
    </div>
    <script>
      document.addEventListener('click', function(event) {
        var dropdown = document.getElementById('profile-dropdown');
        var btn = document.getElementById('profile-btn');
        if (!btn.contains(event.target)) {
          dropdown.classList.remove('show');
          dropdown.style.display = 'none';
        } else {
          dropdown.style.display = dropdown.classList.contains('show') ? 'block' : 'none';
        }
      });

      // Terminar sessão com confirmação
      document.addEventListener('DOMContentLoaded', function() {
        var logoutBtn = document.getElementById('btn-logout');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Tem a certeza que deseja terminar sessão?')) {
              localStorage.removeItem('userId');
              sessionStorage.removeItem('userId');
              window.location.href = '{{navPrefix}}registo.html';
            }
          });
        }
        // Corrigir link Ver Perfil para propagar id
        var perfilLink = document.getElementById('ver-perfil-link');
        var userId = localStorage.getItem('userId') || sessionStorage.getItem('userId');
        if (perfilLink) {
          perfilLink.addEventListener('click', function(e) {
            e.preventDefault();
            if (!userId) {
              window.location.href = '{{navPrefix}}login.html';
              return;
            }
            window.location.href = '{{navPrefix}}perfil.html?id=' + userId;
          });
        }
      });
    </script>
</header>

<script>
    const headerConfig = {
        navPrefix: '{{navPrefix}}',
        userType: '{{user.type}}',
        userId: '{{#user.authenticated}}{{user.id}}{{/user.authenticated}}{{^user.authenticated}}null{{/user.authenticated}}'
    };
</script>
<script src="{{headerJs}}"></script>