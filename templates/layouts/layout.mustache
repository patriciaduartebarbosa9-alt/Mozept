<?php
require_once 'config.php';
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    {{> metadata}}
    <!-- Latest compiled and minified CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">    
    <link rel="stylesheet" href="/assets/css/styles.css">
   

    
    {{> styles}}
  </head>
<body class="{{bodyClass}}">
    {{> header}}
    
    <main>
        {{$main}}{{/main}}
    </main>
    
    {{> footer}}
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/4.0.0/mustache.min.js"></script>
    <script src="/assets/js/main.js"></script>
    {{> scripts}}
         <script>
         // Guardar o id do utilizador da query string em localStorage e manter em todas as páginas
         (function() {
             const params = new URLSearchParams(window.location.search);
             const userId = params.get('id');
             // Só atualizar localStorage se a página for perfil.html, edit-profile.html, reserva.html, mensagens.html
             const privPages = ['perfil.html', 'edit-profile.html', 'reserva.html', 'mensagens.html'];
             const isPriv = privPages.some(p => window.location.pathname.endsWith(p));
             if (userId && isPriv) {
                 localStorage.setItem('userId', userId);
             }
             window.getUserId = function() {
                 return localStorage.getItem('userId');
             };
             // Propagar o id do utilizador nos links de navegação
             // Corrigir: nunca sobrescrever userId do localStorage ao navegar para páginas públicas
             document.addEventListener('DOMContentLoaded', function() {
                 const uid = localStorage.getItem('userId');
                 if (uid) {
                     document.querySelectorAll('nav.nav a').forEach(function(link) {
                         const url = new URL(link.href, window.location.origin);
                         // Só propaga id se for página privada (mensagens, reserva, perfil, etc.)
                         if (url.pathname.includes('perfil.html') || url.pathname.includes('mensagens.html') || url.pathname.includes('reserva.html')) {
                             url.searchParams.set('id', uid);
                             link.href = url.pathname + url.search;
                         } else {
                             // Para páginas públicas, remove id
                             url.searchParams.delete('id');
                             link.href = url.pathname + url.search;
                         }
                     });
                 }
                 // Adicionar evento de logout se existir botão/link com id="logout-btn"
                 const logoutBtn = document.getElementById('logout-btn');
                 if (logoutBtn) {
                     logoutBtn.addEventListener('click', function(e) {
                         localStorage.removeItem('userId');
                         window.location.href = 'login.html';
                     });
                 }
             });
         })();
         </script>
      
     <script>
     // Guardar o id do utilizador da query string em localStorage e manter em todas as páginas
     (function() {
         const params = new URLSearchParams(window.location.search);
         const userId = params.get('id');
         // Só atualizar localStorage se a página for perfil.html, edit-profile.html, reserva.html, mensagens.html
         const privPages = ['perfil.html', 'edit-profile.html', 'reserva.html', 'mensagens.html'];
         const isPriv = privPages.some(p => window.location.pathname.endsWith(p));
         if (userId && isPriv) {
             localStorage.setItem('userId', userId);
         }
         // Se não houver id na query mas existe em localStorage, garantir que está disponível
         window.getUserId = function() {
             return localStorage.getItem('userId');
         };
         // Propagar o id do utilizador nos links de navegação
         document.addEventListener('DOMContentLoaded', function() {
             const uid = localStorage.getItem('userId');
             if (uid) {
                 document.querySelectorAll('nav.nav a').forEach(function(link) {
                     const url = new URL(link.href, window.location.origin);
                     // Só propaga id se for página privada (mensagens, reserva, perfil, etc.)
                     if (url.pathname.includes('perfil.html') || url.pathname.includes('mensagens.html') || url.pathname.includes('reserva.html')) {
                         url.searchParams.set('id', uid);
                         link.href = url.pathname + url.search;
                     } else {
                         // Para páginas públicas, remove id
                         url.searchParams.delete('id');
                         link.href = url.pathname + url.search;
                     }
                 });
             }
         });
     })();
     </script>
     </body>
</html>
